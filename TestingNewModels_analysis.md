# –ê–Ω–∞–ª–∏–∑ TestingNewModels.ipynb ‚Äî –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∑–∞–º–µ—á–∞–Ω–∏—è

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

## 1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ / –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–´)

### 1.1. multipletests –ø–∞–¥–∞–µ—Ç –Ω–∞ NaN p-values

**–ì–¥–µ:** —è—á–µ–π–∫–∞ 6, —Ñ—É–Ω–∫—Ü–∏—è `select_features_spearman_fdr`.

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—ã–µ —Ñ–∏—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π), `spearmanr` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `NaN` –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –∏ `NaN` p-value. –§—É–Ω–∫—Ü–∏—è `multipletests` (FDR –∫–æ—Ä—Ä–µ–∫—Ü–∏—è) –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å `NaN` (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `NaN` –≤ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö p-values –∏–ª–∏ –ø–∞–¥–∞–µ—Ç), —á—Ç–æ –ª–æ–º–∞–µ—Ç –æ—Ç–±–æ—Ä —Ñ–∏—á–µ–π.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–≤–Ω–µ—Å–µ–Ω–æ):** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `if np.isnan(p_val): corr=0.0; p_val=1.0`.

---

### 1.2. –ü—Ä–æ–ø—É—Å–∫ fold –ø—Ä–∏ –Ω—É–ª–µ –æ—Ç–æ–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏—á–µ–π

**–ì–¥–µ:** —è—á–µ–π–∫–∞ 7, —Ü–∏–∫–ª walk-forward CV.

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ `len(selected_features) == 0` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `continue`, –∏ –≤ `fold_results` –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è. –í –∏—Ç–æ–≥–µ:
- –≤ —Å–≤–æ–¥–∫–µ (—è—á–µ–π–∫–∞ 8) –±—É–¥–µ—Ç –º–µ–Ω—å—à–µ —Å—Ç—Ä–æ–∫, —á–µ–º —á–∏—Å–ª–æ —Å–ø–ª–∏—Ç–æ–≤;
- –≤ —è—á–µ–π–∫–µ 9 `fold_results[-1]` –∏ `list(tscv.split(X_all))[-1]` –º–æ–≥—É—Ç –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ —Ä–∞–∑–Ω—ã–º fold'–∞–º (–µ—Å–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π fold).

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–≤–Ω–µ—Å–µ–Ω–æ):** –ü—Ä–∏ 0 —Ñ–∏—á–µ–π –≤ `fold_results` –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è placeholder; –≤ —è—á–µ–π–∫–µ 9 –±–µ—Ä—ë—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π fold —Å –æ–±—É—á–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª—å—é.

---

## 2. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–∞–≥–∏

### 2.1. –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Ñ–∏—á–µ–π –≤ `select_features_spearman_fdr`

**–ì–¥–µ:** —è—á–µ–π–∫–∞ 6, fallback –ø—Ä–∏ –º–∞–ª–æ–º —á–∏—Å–ª–µ –∑–Ω–∞—á–∏–º—ã—Ö –ø–æ FDR.

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –≤–µ—Ç–∫–µ `else` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `fallback = stats[stats['p_raw'] < 0.01].head(max_features)`. –ï—Å–ª–∏ –Ω–∏ —É –æ–¥–Ω–æ–π —Ñ–∏—á–∏ `p_raw < 0.01`, —Ç–æ `selected = []`. Caller —Ç–æ–≥–¥–∞ –¥–µ–ª–∞–µ—Ç `continue` –∏ —Ç–µ—Ä—è–µ—Ç fold (—Å–º. 1.2).

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–≤–Ω–µ—Å–µ–Ω–æ):** –í –∫–æ–Ω—Ü–µ `select_features_spearman_fdr` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ `selected` –ø—É—Å—Ç–æ–π –∏ –≤ `stats` –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏ ‚Äî –±–µ—Ä—ë—Ç—Å—è top-1 –ø–æ `abs_corr`.

---

### 2.2. –ü–æ—Ä—è–¥–æ–∫ –ø–∞–π–ø–ª–∞–π–Ω–∞ –∏ –ª–∞–≥–∏

**–ì–¥–µ:** —è—á–µ–π–∫–∞ 3.

**–ü–æ –ø—Ä–æ–µ–∫—Ç—É (CLAUDE.md):** –ø–æ—Å–ª–µ `add_engineered_features` –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ `add_lags` (gold + sp500), –∑–∞—Ç–µ–º `add_y_up_custom`. –í –Ω–æ—É—Ç–±—É–∫–µ –º–µ–∂–¥—É –Ω–∏–º–∏ –≤—Å—Ç–∞–≤–ª–µ–Ω—ã TA-—Ñ–∏—á–∏. –î–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Å –æ—Å–Ω–æ–≤–Ω—ã–º –ø–∞–π–ø–ª–∞–π–Ω–æ–º –∏ Predictor –ª—É—á—à–µ —è–≤–Ω–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–∫—É: ensure_spot_prefix ‚Üí ffill ‚Üí add_engineered_features ‚Üí add_lags ‚Üí add_y_up_custom, –∞ TA-—Ñ–∏—á–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ –ª–∞–≥–æ–≤ –ø–æ –æ–¥–Ω–æ–º—É –∏ —Ç–æ–º—É –∂–µ –ø—Ä–∞–≤–∏–ª—É –≤–µ–∑–¥–µ (–∏ –≤ –Ω–æ—É—Ç–±—É–∫–µ, –∏ –≤ Predictor, –µ—Å–ª–∏ –æ–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TA).

---

## 3. –°—Ç–∏–ª—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

### 3.1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –¥–∞—Ç–∞—Å–µ—Ç

**–ì–¥–µ:** –∫–æ–Ω–µ—Ü —è—á–µ–π–∫–∏ 3.

**–ü—Ä–æ–±–ª–µ–º–∞:** `df2 = df_all` –∏ –¥–∞–ª—å—à–µ –≤–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `df2`. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—É—Å–∫–µ —è—á–µ–µ–∫ –ª–µ–≥–∫–æ –∑–∞–±—ã—Ç—å, —á—Ç–æ `df2` –∏ `df_all` ‚Äî –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –æ–±—ä–µ–∫—Ç; –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ–¥–Ω–æ–≥–æ –∏–∑ –Ω–∏—Ö –∏–∑–º–µ–Ω–∏—Ç—Å—è –∏ –¥—Ä—É–≥–æ–π.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Å—Ç–∞–≤–∏—Ç—å –æ–¥–Ω—É –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ `df_all`) –∏–ª–∏ —è–≤–Ω–æ –ø–∏—Å–∞—Ç—å –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —á—Ç–æ `df2` ‚Äî –∞–ª–∏–∞—Å –¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞.

---

### 3.2. `pip install` –≤ —è—á–µ–π–∫–µ

**–ì–¥–µ:** —è—á–µ–π–∫–∞ 5.

**–ü—Ä–æ–±–ª–µ–º–∞:** `pip install statsmodels` –≤ –Ω–æ—É—Ç–±—É–∫–µ —É—Å–ª–æ–∂–Ω—è–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å. –ü—Ä–∏ —Å–º–µ–Ω–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å `statsmodels` –≤ `requirements.txt` –∏ –≤ –Ω–æ—É—Ç–±—É–∫–µ –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å `pip install`.

---

### 3.3. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç

**–ì–¥–µ:** —è—á–µ–π–∫–∞ 2.

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è `LoggingSystem`, –Ω–æ –≤ –Ω–æ—É—Ç–±—É–∫–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–¥–∞–ª–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏.

---

## 4. –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–Ω–µ –±–∞–≥–∏ –∫–æ–¥–∞)

- **Permutation importance –Ω–∞ holdout:** —É –æ–±–µ–∏—Ö —Ñ–∏—á–µ–π importance –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π ‚Äî –º–æ–¥–µ–ª—å –Ω–∞ —ç—Ç–∏—Ö —Ñ–∏—á–∞—Ö –Ω–µ –¥–∞—ë—Ç —É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ –≤—ã—à–µ —à—É–º–∞; —ç—Ç–æ —Å–ª–µ–¥—Å—Ç–≤–∏–µ —Å–ª–∞–±–æ–π –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–π —Å–∏–ª—ã, –∞ –Ω–µ –æ—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ.
- **FDR —á–∞—Å—Ç–æ –Ω–µ –¥–∞—ë—Ç 3+ –∑–Ω–∞—á–∏–º—ã—Ö:** –æ—Ç–±–æ—Ä –ø–∞–¥–∞–µ—Ç –≤ fallback (raw p < 0.01), –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤ —Ä—è–¥–µ fold'–æ–≤ –æ—Å—Ç–∞—ë—Ç—Å—è 1‚Äì2 —Ñ–∏—á–∏ ‚Äî –≤—ã–±–æ—Ä–∫–∞ –∏ –ø–æ—Ä–æ–≥–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –∂—ë—Å—Ç–∫–∏–º–∏.

---

## 5. –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º –∑–∞–ø—É—Å–∫–µ:

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `all_feature_sets` (—è—á–µ–π–∫–∞ 7):** –£–±—Ä–∞–Ω–æ –¥–≤–æ–π–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø—É—Å—Ç–æ–º —Å–ø–∏—Å–∫–µ —Ñ–∏—á–µ–π.
2. **NaN –≤ `smart_corr_removal` (—è—á–µ–π–∫–∞ 6):** –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ `if not np.isnan(c) else 0.0`.
3. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ Permutation Importance (—è—á–µ–π–∫–∞ 9):** –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `fold_idx = best['fold'] - 1` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö test –¥–∞–Ω–Ω—ã—Ö.
4. **–£–¥–∞–ª–µ–Ω –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç `LoggingSystem` (—è—á–µ–π–∫–∞ 2).**
5. **–£–±—Ä–∞–Ω `pip install` –∏–∑ —è—á–µ–π–∫–∏ 5,** –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ –∏–º–ø–æ—Ä—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
6. **–£–¥–∞–ª–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `df2`,** –≤–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `df_all`.

### üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –±—É–¥—É—â–µ–≥–æ:

1. –î–æ–±–∞–≤–∏—Ç—å `statsmodels` –≤ `requirements.txt`.
2. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ —à–∞–≥–æ–≤ –ø–∞–π–ø–ª–∞–π–Ω–∞ (–≤–∫–ª—é—á–∞—è TA –∏ –ª–∞–≥–∏) –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—ã—Ä–æ–≤–Ω—è—Ç—å —Å –æ—Å–Ω–æ–≤–Ω—ã–º –ø–∞–π–ø–ª–∞–π–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–∞.
